<?xml version="1.0" encoding="utf-8"?>
<robot name="mars_rover" xmlns:xacro="http://www.ros.org/wiki/xacro">

    <xacro:property name="package_name" value="rover_description" />
    <xacro:property name="wheel_radius" value="0.11" />
    <xacro:property name="wheel_length" value="0.144" />
    <xacro:property name="camera_size" value="0.05" />
    <xacro:property name="camera_mass" value="0.01" />

    <material name="grey"><color rgba="0.75 0.75 0.75 1" /></material>
    <material name="blue"><color rgba="0 0 1 1"/></material>
    <material name="red"><color rgba="1 0 0 1"/></material>
    <material name="green"><color rgba="0 1 0 1"/></material>
    <material name="yellow"><color rgba="1 1 0 1"/></material>

<!-- Gazebo-specific sensors & physics -->
    <xacro:include filename="$(find rover_description)/urdf/rover.gazebo"/>

<!--BASE LINKS-->
    <link name="base_link"/>
    <link name="base_footprint"/>

    <joint name="base_footprint_tf" type="fixed">
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <parent link="base_link"/>
        <child link="base_footprint"/>
    </joint>
<!--CHASSIS LINK-->
    <link name="chassis">
        <inertial>
            <origin xyz="-0.169915088395825 -0.00199596460135764 -0.00919692919066987" rpy="0 0 0" />
            <mass value="14.4435926271869" />
            <inertia ixx="0.0717912278135852"
            ixy="-7.70091070297908E-07"
            ixz="-6.88067299368864E-07"
            iyy="0.298762417937452"
            iyz="2.41721140540893E-08"
            izz="0.359670360949306" />
        </inertial>
        <visual>
            <geometry>
                <mesh filename="package://${package_name}/meshes/base_link.STL" />
            </geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry>
                <mesh filename="package://${package_name}/meshes/base_link.STL" />
            </geometry>
        </collision>
    </link>

    <joint name="connector" type="fixed">
        <origin xyz="0 0 0.4" rpy="0 0 0"/>
        <parent link="base_link"/>
        <child link="chassis"/>
    </joint>

<!--##############################################################################-->
<!--DEFINING CAMERA-UNIT-->
<!--##############################################################################-->
    <xacro:macro name="camera_unit" params="link_name optical_link_name joint_name optical_joint_name color_name rgba">
    
        <link name="${link_name}">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <box size="${camera_size} ${camera_size} ${camera_size}"/>
                </geometry>
                <material name="${color_name}">
                    <color rgba="${rgba}"/>
                </material>
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                <box size="${camera_size} ${camera_size} ${camera_size}"/>
                </geometry>
            </collision>
            <inertial>
                <mass value="${camera_mass}"/>
                <inertia ixx="0.0001" ixy="0.0" ixz="0.0" iyy="0.0001" iyz="0.0" izz="0.0001"/>
            </inertial>
        </link>
        <link name="${optical_link_name}"/>

        <joint name="${optical_joint_name}" type="fixed">
            <parent link="${link_name}"/>
            <child link="${optical_link_name}"/>
            <origin xyz="0 0 0" rpy="-1.57 0 -1.57"/>
        </joint>
    </xacro:macro>

<!--CAMERA UNIT - 1-->
    <xacro:camera_unit 
        link_name="camera_link" 
        optical_link_name="camera_optical_link" 
        joint_name="camera_joint" 
        optical_joint_name="camera_optical_joint" 
        color_name="blue" 
        rgba="0 0 1 1" />

    <joint name="camera_joint" type="fixed">
        <parent link="chassis"/>
        <child link="camera_link"/>
        <origin xyz="0.1 0 0.1" rpy="0 0 0"/>
    </joint>

<!--CAMERA UNIT - 2-->
    <xacro:camera_unit 
        link_name="camera_link_1" 
        optical_link_name="camera_optical_link_1" 
        joint_name="camera_joint_1" 
        optical_joint_name="camera_optical_joint_1" 
        color_name="red" 
        rgba="1 0 0 1" />

    <joint name="camera_joint_1" type="fixed">
        <parent link="chassis"/>
        <child link="camera_link_1"/>
        <origin xyz="0 0.24 0.1" rpy="0 0 1.57"/>
    </joint>

<!--CAMERA UNIT - 3-->
    <xacro:camera_unit 
        link_name="camera_link_2" 
        optical_link_name="camera_optical_link_2" 
        joint_name="camera_joint_2" 
        optical_joint_name="camera_optical_joint_2" 
        color_name="green" 
        rgba="0 1 0 1" />

    <joint name="camera_joint_2" type="fixed">
        <parent link="chassis"/>
        <child link="camera_link_2"/>
        <origin xyz="0 -0.24 0.1" rpy="0 0 -1.57"/>
    </joint>

<!--IMU-->
    <link name="imu_link">
        <visual>
            <geometry><box size="0.02 0.02 0.01"/></geometry>
            <material name="yellow"/>
        </visual>
        <inertial>
            <mass value="0.001"/><inertia ixx="1e-5" ixy="0" ixz="0" iyy="1e-5" iyz="0" izz="1e-5"/>
        </inertial>
    </link>
    <joint name="imu_joint" type="fixed">
        <origin xyz="0 0 0" rpy="0 0 0" />
        <parent link="chassis"/>
        <child link="imu_link"/>
    </joint>
<!--GPS-->
    <link name="gps_link"/>
    <joint name="gps_joint" type="fixed">
        <parent link="base_link"/>
        <child link="gps_link"/>
        <origin xyz="0 0 0.5" rpy="0 0 0"/>
    </joint>

<!--#################################################-->
<!--WHEEL + STEERING (1)-->
<!--#################################################-->
    <link name="steering1">
        <inertial>
            <origin xyz="0.000525112226394842 -0.0335326994132589 -0.193802692885311" rpy="0 0 0" />
            <mass value="6.6483" />
            <inertia ixx="0.0236327074483744"
            ixy="1.53496169623355E-05"
            ixz="6.57674614863919E-06"
            iyy="0.019303321564257"
            iyz="-0.00126381697267368"
            izz="0.0217357170628441" />
        </inertial>
        <visual>
            <geometry><mesh filename="package://${package_name}/meshes/steering1.STL" /></geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry><mesh filename="package://${package_name}/meshes/steering1.STL" /></geometry>
        </collision>
    </link>

    <joint name="steer1" type="fixed">
        <origin xyz="-0.52941 0.29162 -0.12851" rpy="0 -1.83e-05 0" />
        <parent link="chassis" /><child link="steering1" /><axis xyz="0 0 1" />
    </joint>

    <link name="wheel1">
        <inertial>
            <origin xyz="-0.000142261151015677 0.000391028851553232 -0.067999985619256" rpy="0 0 0" />
            <mass value="1.9617" />
            <inertia ixx="0.0111765177053231"
            ixy="3.63484716438248E-14"
            ixz="-9.83139513884305E-10"
            iyy="0.0111765177116241"
            iyz="-1.70424653629502E-07"
            izz="0.0157859329323531" />
        </inertial>
        <visual>
            <geometry><mesh filename="package://${package_name}/meshes/wheel1.STL" /></geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry><cylinder radius="${wheel_radius}" length="${wheel_length}"/></geometry>
        </collision>
    </link>

    <joint name="wheel_1" type="continuous">
        <origin xyz="0.000353156675627797 0.0676257237290513 -0.216586122585117" rpy="-1.5708332999603 1.83526331234849E-05 0.00321478961806723" />
        <parent link="steering1" /><child link="wheel1" /><axis xyz="0 0 1" />
    </joint>
 
<!--#################################################-->
<!--WHEEL + STEERING (2)-->
<!--#################################################-->
    <link name="steering2">
        <inertial>
            <origin xyz="-0.000474889077884733 0.0341947940956224 -0.19380284134621" rpy="0 0 0" />
            <mass value="6.6483" />
            <inertia ixx="0.0236304005612626"
            ixy="0.000114678117693231"
            ixz="-3.02547344080121E-05"
            iyy="0.019306197957872"
            iyz="0.00125759688431803"
            izz="0.0217350588985547"/>
        </inertial>
        <visual>
            <geometry><mesh filename="package://${package_name}/meshes/steering2.STL" /></geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry><mesh filename="package://${package_name}/meshes/steering2.STL" /></geometry>
        </collision>
    </link>

    <joint name="steer2" type="fixed">
        <origin xyz="-0.52941 -0.29162 -0.12851" rpy="0 0 0" />
        <parent link="chassis" /><child link="steering2" /><axis xyz="0 0 1" />
    </joint>

    <link name="wheel2">
        <inertial>
            <origin xyz="-0.000413021540613123 -2.44790194104949E-05 0.0679999999991169" rpy="0 0 0" />
            <mass value="1.9617" />
            <inertia ixx="0.0111765177053229"
            ixy="1.46936453891669E-17"
            ixz="-1.59919820441612E-18"
            iyy="0.0111765177053229"
            iyz="-1.6690363377749E-17"
            izz="0.0157859329386544"  />
        </inertial>
        <visual>
            <geometry><mesh filename="package://${package_name}/meshes/wheel2.STL" /></geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry><cylinder radius="${wheel_radius}" length="${wheel_length}"/></geometry>
        </collision>
    </link>

    <joint name="wheel_2" type="continuous">
        <origin xyz="0.00260503655999339 -0.0673405250297557 -0.216999105202697" rpy="-1.5707963267949 0 0.0261401718711602" />
        <parent link="steering2" /><child link="wheel2" /><axis xyz="0 0 1" />
    </joint>

<!--#################################################-->
<!--WHEEL + STEERING (3)-->
<!--#################################################-->
    <link name="steering3">
        <inertial>
            <origin xyz="-0.000416600731458772 0.0335152875528032 -0.193802433433151" rpy="0 0 0" />
            <mass value="6.6483" />
            <inertia ixx="0.0236333353649771"
            ixy="1.52860727031699E-06"
            ixz="-3.17219019035638E-06"
            iyy="0.0193032353280473"
            iyz="0.00126391062872571"
            izz="0.0217350863633826"/>
        </inertial>
        <visual>
            <geometry><mesh filename="package://${package_name}/meshes/steering3.STL" /></geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry><mesh filename="package://${package_name}/meshes/steering3.STL" /></geometry>
        </collision>
    </link>

    <joint name="steer3" type="fixed">
        <origin xyz="0.32344 -0.29562 -0.1285" rpy="0 0 0" />
        <parent link="chassis" /><child link="steering3" /><axis xyz="0 0 1" />
    </joint>

    <link name="wheel3">
        <inertial>
            <origin xyz="0.00012752326976001 0.000393603647906415 0.0679999999986239" rpy="0 0 0" />
            <mass value="1.9617" />
            <inertia ixx="0.0111765177053229"
            ixy="1.46784681409658E-17"
            ixz="-1.1367644329826E-15"
            iyy="0.0111765177053229"
            iyz="-3.63032951516692E-17"
            izz="0.0157859329386544"   />
        </inertial>
        <visual>
            <geometry><mesh filename="package://${package_name}/meshes/wheel3.STL" /></geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry><cylinder radius="${wheel_radius}" length="${wheel_length}"/></geometry>
        </collision>
    </link>

    <joint name="wheel_3" type="continuous">
        <origin xyz="-0.000555418729084156 -0.067625619393596 -0.216581022537134" rpy="-1.5707963267949 0 0"/>
        <parent link="steering3" /><child link="wheel3" /><axis xyz="0 0 1" />
    </joint>

<!--#################################################-->
<!--WHEEL + STEERING (4)-->
<!--#################################################-->
    <link name="steering4">
        <inertial>
            <origin xyz="-0.00011106391877802 -0.0338081154233735 -0.19380292769291" rpy="0 0 0" />
            <mass value="6.6483" />
            <inertia ixx="0.0236324149128355"
            ixy="4.11539442084093E-05"
            ixz="8.21164009695582E-06"
            iyy="0.0193036407758429"
            iyz="-0.00125789757300897"
            izz="0.0217356897618841" />
        </inertial>
        <visual>
            <geometry><mesh filename="package://${package_name}/meshes/steering4.STL" /></geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry><mesh filename="package://${package_name}/meshes/steering4.STL" /></geometry>
        </collision>
    </link>

    <joint name="steer4" type="fixed">
        <origin xyz="0.32345 0.29186 -0.12849" rpy="0 -1.8353E-05 0"/>
        <parent link="chassis" /><child link="steering4" /><axis xyz="0 0 1" />
    </joint>

    <link name="wheel4">
        <inertial>
            <origin xyz="0.000413714800629517 -5.10683655707833E-06 -0.0679999999999992" rpy="0 0 0" />
            <mass value="1.9617" />
            <inertia ixx="0.0111765177053229"
            ixy="7.33822171003051E-18"
            ixz="-1.84314369322536E-18"
            iyy="0.011176517705323"
            iyz="-2.23015354728552E-17"
            izz="0.0157859329386545"   />
        </inertial>
        <visual>
            <geometry><mesh filename="package://${package_name}/meshes/wheel4.STL" /></geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry><cylinder radius="${wheel_radius}" length="${wheel_length}"/></geometry>
        </collision>
    </link>

    <joint name="wheel_4" type="continuous">
        <origin xyz="-0.00146559562126541 0.0673855594536285 -0.21697972522299" rpy="-1.5707963246485 1.83519361346148E-05 0.00917303616199558"/>
        <parent link="steering4" /><child link="wheel4" /><axis xyz="0 0 1" />
    </joint>
    <!--ROS2-Control-->

    <ros2_control name="RobotController" type="system">
        <hardware>
            <plugin>gz_ros2_control/GazeboSimSystem</plugin>
        </hardware>
        <xacro:macro name="wheel_interface" params="name">
            <joint name="${name}">
                <command_interface name="velocity"/>
                <state_interface name="position"/>
                <state_interface name="velocity"/>
            </joint>
        </xacro:macro>
        <xacro:wheel_interface name="wheel_1"/>
        <xacro:wheel_interface name="wheel_2"/>
        <xacro:wheel_interface name="wheel_3"/>
        <xacro:wheel_interface name="wheel_4"/>
    </ros2_control>
</robot>